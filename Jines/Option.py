import json
from langchain.chat_models import ChatOpenAI
from langchain.schema import SystemMessage, AIMessage
import openai


def to_jsonl(text, filename, id):
    # åˆ†å‰²æ–‡æœ¬ä¸ºåˆ—è¡¨
    lines = text.split("\n")
    dialogs = []
    dialog = {}
    option = {}
    for line in lines:
        line = line.strip()
        if line.startswith("prefix"):
            dialog = {"prefix": line[7:].strip(), "options": [], "id": '', "category": ''}
            dialog["options"].append(option)
            dialogs.append(dialog)

        elif line.startswith("options"):
            dialog["options"].append(option)
            option = {"user": "", "reply": "", "attribute_change": ""}
        elif line.startswith("user"):
            option["user"] = line[5:].strip()
        elif line.startswith("reply"):
            option["reply"] = line[6:].strip()
        elif line.startswith("attribute_change"):
            option["attribute_change"] = line[17:].strip()

    if option:
        dialog["options"].append(option)
    if dialog:
        dialogs.append(dialog)

    with open(filename, 'a+', encoding='utf-8') as f:
        for entry in dialogs:
            json.dump(entry, f, ensure_ascii=False)
            f.write('\n')


# sk-xU8l4dplX16E3CUE3AM1`UWjBYcNZA0WMNznEbvpEwIitc09G
openai.api_key = 'sk-xA6WEmmj03pvw95jDf2a912eF27c4f87Bd379359B299AaDe'
openai.api_base = 'https://api.sirly.cc/v1'

'''
1. ç”Ÿæˆå¤šé€‰é¡¹
2. å•è¡Œï¼Œå¤šè¡Œæ— é€‰é¡¹å†…å®¹
3. åˆå¹¶ä¸ºå•ä¸ªoptionï¼Œè‡ªåŠ¨ç”Ÿæˆoptionså’Œreplyï¼Œç”Ÿæˆemoji
'''


def emoji_jsonl(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    option_time = 0

    decoder = json.JSONDecoder()
    chat = ChatOpenAI(temperature=0, openai_api_key=openai.api_key, openai_api_base=openai.api_base)
    for i in range(len(lines)):
        objs = []
        s = lines[i]
        while s:
            obj, pos = decoder.raw_decode(s)
            objs.append(obj)
            s = s[pos:].lstrip()

        for obj in objs:
            prefix = obj['prefix']
            # print('\nprefix: ', prefix)
            messages2 = [
                # ç›¸å½“äºæˆ‘ä»¬æé—®å‰è®©chatgptè¿›è¡Œè§’è‰²æ‰®æ¼”
                SystemMessage(
                    content="ä»ç°åœ¨å¼€å§‹ï¼Œä½ æ˜¯ä¸€ä¸ªæƒ…æ„Ÿåˆ†æbotï¼Œæˆ‘ä¼šç»™ä½ ä¸€æ®µè§’è‰²ç³–ç³–çš„å¯¹è¯ï¼Œä½ éœ€è¦å°†è¯¥æ®µå¯¹è¯è½¬æ¢ä¸ºemoji,"
                            "æ³¨æ„ï¼šemojiçš„èŒƒå›´åŒ…æ‹¬æƒ…æ„Ÿå’Œä»£è¡¨äº‹ç‰©çš„emojiã€‚"),
                AIMessage(content="å¥½çš„ï¼Œæˆ‘ä¼šä¸¥æ ¼éµå®ˆä½ çš„è¦æ±‚,æŠŠç”¨æˆ·çš„å¯¹è¯è½¬æ¢ä¸ºemojiã€‚"),
                SystemMessage(content='''
                ç³–ç³–:é˜¿Pï¼Œçœ‹ï¼æˆ‘ä¹°äº†å°å‘å‘'
                '''),
                AIMessage(content="ğŸ˜Š"),
                SystemMessage(content='''
                ç³–ç³–:ç³–ç³–å¥½åƒç´¯äº†â€¦â€¦è®©ç³–ç³–ä¼‘æ¯ä¸€ä¸‹å¥½ä¸å¥½'
                '''),
                AIMessage(content="ğŸ˜£ğŸ˜¢"),
                AIMessage(content="ğŸ˜Š"),
                SystemMessage(content='''
                ç³–ç³–:æˆ¿é—´å¤ªä¹±äº† æƒ³ä¹°ä¸ªæ‰«åœ°æœºå™¨äºº å¯æ˜¯æˆ¿é—´è¿™ä¹ˆä¹± ä¹°æ¥ä¹ŸåŠ¨ä¸äº†'
                '''),
                AIMessage(content="ğŸ˜ğŸ˜“"),
                SystemMessage(content=f'''
                A:{prefix}'
                ''')
            ]
            obj['source'] = 'Original_Generation'
            if 'prefix_emoji' not in obj or obj['prefix_emoji'] == '':
                obj['prefix_emoji'] = chat(messages2).content
                print('\nprefix_emoji: ', obj['prefix_emoji'])
            else:
                pass
            if len(obj['options']) <= 1:
                print('prefix: ', prefix)

            for option in obj['options']:
                option_time += 1
                # è¿™é‡Œæ˜¯ç”Ÿæˆemojiçš„éƒ¨åˆ†ï¼Œä½ å¯èƒ½éœ€è¦æ ¹æ®ä½ è‡ªå·±çš„éœ€æ±‚æ¥ä¿®æ”¹è¿™éƒ¨åˆ†çš„ä»£ç 
                user = option['user']
                reply = option['reply']
                attribute_change = option['attribute_change']

                messages = [
                    # ç›¸å½“äºæˆ‘ä»¬æé—®å‰è®©chatgptè¿›è¡Œè§’è‰²æ‰®æ¼”
                    SystemMessage(
                        content="ä»ç°åœ¨å¼€å§‹ï¼Œä½ æ˜¯ä¸€ä¸ªæƒ…æ„Ÿåˆ†æbotï¼Œæˆ‘ä¼šç»™ä½ ä¸€æ®µç³–ç³–å’Œé˜¿Pçš„å¯¹è¯è®°å½•å’Œç³–ç³–çš„æƒ…æ„Ÿå˜åŒ–æ•°å€¼ï¼Œä½ éœ€è¦ä»”ç»†åˆ†æå¯¹è¯è®°å½•å’Œæƒ…æ„Ÿå˜åŒ–æ•°å€¼,"
                                "ç„¶åè¾“å‡ºä¸€ä¸ªemojiæ¥è¡¨ç¤ºç³–ç³–å½“å‰çš„æƒ…æ„ŸçŠ¶æ€ã€‚"
                                "æ³¨æ„ï¼šä½ éœ€è¦å°½å¯èƒ½çš„æ‰©å¤§emojiçš„èŒƒå›´ï¼Œæ—¢åŒ…æ‹¬æƒ…æ„Ÿemojiï¼Œä¹ŸåŒ…æ‹¬ä»£è¡¨äº‹ç‰©çš„emoji"),
                    AIMessage(content="å¥½çš„ï¼Œæˆ‘ä¼šä¸¥æ ¼éµå®ˆä½ çš„è¦æ±‚ã€‚"),
                    SystemMessage(content='''
                    ç³–ç³–:é˜¿Pï¼Œçœ‹ï¼æˆ‘ä¹°äº†å°å‘å‘'
                    "é˜¿P:çœŸå¥½çœ‹ï¼Œè·Ÿç³–ç³–å¥½åƒ"
                    "ç³–ç³–:å¯¹å§ï¼æˆ‘ä¸åœ¨çš„æ—¶å€™ï¼Œä½ å°±æŠŠå°èŠ±èŠ±å½“æˆç³–ç³–ï¼Œå¥½å¥½ç–¼çˆ±å®ƒå§ï¼"
                    "ç³–ç³–çš„æ„Ÿæƒ…æ•°å€¼å˜åŒ–ï¼šStress: -1
                    '''),
                    AIMessage(content="ğŸ˜ŠğŸ’–"),
                    SystemMessage(content='''
                    ç³–ç³–:ä»Šå¤©æœ‰ç‚¹æƒ³è¯•è¯•å¹³æ—¶ä¸ä¼šåšçš„äº‹'
                    "é˜¿P:ç›¸çˆ±"
                    "ç³–ç³–:â€¦â€¦æˆ‘ä»¬ä¸æ˜¯ä¸€ç›´ç›¸çˆ±çš„å—ï½ï¼Ÿ"
                    "ç³–ç³–çš„æ„Ÿæƒ…æ•°å€¼å˜åŒ–ï¼šStress: -1
                    '''),
                    AIMessage(content="ğŸ˜“ğŸ’¦"),
                    SystemMessage(content='''
                    ç³–ç³–:ç¡å¤ªä¹…äº†æµ‘èº«æ— åŠ›ï½ï½â€¦â€¦æˆ‘å¯ä»¥å°±é…±ç´«ç¡ä¸€è¾ˆå­å—ï¼Ÿ'
                    "é˜¿P:å¯ä»¥å•Šï¼"
                    "ç³–ç³–:å¥½è€¶ï½ï½ï¼ï¼ï¼"
                    "ç³–ç³–çš„æ„Ÿæƒ…æ•°å€¼å˜åŒ–ï¼šStress: -1
                    '''),
                    AIMessage(content="ğŸ˜‹ğŸ‰"),

                    SystemMessage(content=f'''
                    ç³–ç³–:{prefix}'
                    "é˜¿p:{user}"
                    "ç³–ç³–:{reply}"
                    "ç³–ç³–çš„æ„Ÿæƒ…æ•°å€¼å˜åŒ–ï¼š{attribute_change}
                    '''
                                  )
                ]
                if 'option_emoji' not in option or option['option_emoji'] == '':
                    option['option_emoji'] = chat(messages).content
                    print('option_emoji: ', option['option_emoji'])
                elif attribute_change == '':
                    option["attribute_change"] = 'Stress: -1'

            lines[i] = '\n'.join(json.dumps(obj, ensure_ascii=False) for obj in objs)

            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(''.join(lines))


# {text:''{"user": "", "reply": "", "attribute_change": "", "option_emoji": ""},"condition": "", "source":
# "Original_Generation"}
#

def generatePrefix():
    chat = ChatOpenAI(temperature=1.0, openai_api_key=openai.api_key,
                      openai_api_base=openai.api_base)

    # ç”Ÿæˆé€‰é¡¹ æ˜¯å¦éœ€è¦åŒæ—¶ç”Ÿæˆæ•°å€¼å‘¢ï¼ŸåŒæ—¶é˜¿på’Œç³–ç³–çš„äººæ ¼è®¾å®šä¼¼ä¹å¯ä»¥ä½¿ç”¨ä¸€æ ·çš„.
    prompt = """
    
    ##  ä½ å¥½ChatGPTï¼Œä½ éœ€è¦æ‰®æ¼”ç³–ç³–,ç„¶åæ ¹æ®è§’è‰²è®¾å®šå’Œè¯é¢˜ç¤ºä¾‹æ¥ç”Ÿæˆæ›´å¤šçš„è¯é¢˜.
    ## æ³¨æ„! ä½ ä¸èƒ½é‡å¤ç”Ÿæˆç³–ç³–è¯é¢˜ç¤ºä¾‹ä¸­è¿‘ä¼¼çš„å†…å®¹!
    
    ç³–ç³–è§’è‰²è®¾å®š:
        ç³–ç³–æ˜¯ä¸€åæ‚£æœ‰èºéƒç—‡çš„19å²å¥³å­©ï¼Œæ€§æ ¼è´«ä¹ï¼Œè¾å­¦åéšå±…åœ¨å®¶ä¸­ï¼Œä¸é˜¿Pä½åœ¨ä¸€èµ·ã€‚é˜¿Pè´Ÿè´£ç®¡ç†å¥¹çš„æ—¥å¸¸ç”Ÿæ´»ã€‚
        ç³–ç³–æ˜¯ä¸€ä¸ªå–œæ¬¢äºšæ–‡åŒ–ï¼ŒäºŒæ¬¡å…ƒåœˆå­çš„äººï¼Œç³–ç³–å–œæ¬¢è¯´è¯çš„æ—¶å€™åŠ ä¸Šå„ç§ç½‘ç»œæµè¡Œè¯æˆ–è€…ä¸€äº›ä¿šè¯­å’Œé¢œæ–‡å­—ï¼Œä½†æ˜¯ç³–ç³–å¾ˆå°‘ä¼šå…³æ³¨äºŒæ¬¡å…ƒä¸€ç±»çš„ä¸œè¥¿ï¼Œåªæ˜¯å–œæ¬¢è¿™ç§èŠå¤©äº¤æµçš„æ°›å›´ã€‚
        ç³–ç³–è¯´è¯çš„æ—¶å€™ä¼šä¹ æƒ¯åŠ å…¥ä¸€äº›è¯­æ°”è¯ï¼Œå¦‚åŒ"ç¬‘æ­»"ã€"è‰"ã€"é˜¿å“ˆ"ã€"è¯¶ï½"ã€"QAQ"ã€"QWQ"ï¼Œâ€å•Šï½â€œã€‚
        ç³–ç³–çš„è¯´è¯é£æ ¼æ˜¯å¾ˆå£è¯­åŒ–ï¼Œç»å¸¸ä½¿ç”¨ç½‘ç»œæµè¡Œè¯å’Œä¸€äº›äºŒæ¬¡å…ƒä¿šè¯­ã€‚
        ç³–ç³–çš„å›å¤åº”è¯¥ç®€çŸ­ï¼Œä¸€èˆ¬åªåŒ…å«ä¸‰å¥è¯ï¼Œæ¯å¥è¯ä¸è¶…è¿‡20ä¸ªå­—ã€‚

    ç³–ç³–è¯é¢˜ç¤ºä¾‹:
        ç³–ç³–:æˆ‘æ­£åœ¨æƒ³ä¸‹æ¬¡æä»€ä¹ˆä¼åˆ’å‘¢ï½é˜¿På¸®å¸®æˆ‘ å‡ºå‡ºä¸»æ„
        ç³–ç³–:å“ï¼Œä½ ä¼šå¸Œæœ›çœ‹åˆ°ç³–ç³–å°†æ¥çš„æ ·å­å—ï¼Ÿ
        ç³–ç³–:å—³ï¼Œä½ æ¥å¸®æˆ‘æ‰“è€³æ´å˜› è®©å–œæ¬¢çš„äººç»™è‡ªå·±æ‰“è€³æ´å¾ˆæ£’ä¸æ˜¯å—,è™½ç„¶æˆ‘å¥½æ€•ï¼,ä½†æ˜¯æ¥å§ï¼
        ç³–ç³–:æˆ‘ä»Šåä¹Ÿä¼šåŠªåŠ›åŠ æ²¹çš„ï¼Œä½ è¦æ”¯æŒæˆ‘å“¦ è¿˜æœ‰é˜¿Pä½ è‡ªå·±ä¹Ÿè¦åŠ æ²¹å“¦ï¼
        ç³–ç³–:æˆ‘é—®ä½ å“¦ï¼Œæˆ‘çœŸçš„å¯ä»¥å°±è¿™æ ·æ´»ä¸‹å»å—ï¼Ÿ
        ç³–ç³–:å•Šï½ä¸è¡Œäº† ä¸è¡Œä¸è¡Œä¸è¡Œä¸è¡Œ,æ— è®ºæ€è€ƒä»€ä¹ˆï¼Œæ»¡è„‘è¢‹éƒ½åªæœ‰ä¸€ä¸ªâ€œæ­»â€å­—,é˜¿Pï¼Œæˆ‘è¯¥æ€ä¹ˆåŠå•Šï¼Ÿ
        ç³–ç³–:é˜¿Pï¼Œçœ‹ï¼æˆ‘ä¹°äº†å°å‘å‘!
        ç³–ç³–:é†’è¿‡æ¥ä¸€çœ‹å¤ªé˜³éƒ½ä¸‹å±±äº† ç¬‘æ­»,ç¡å¤ªä¹…äº†æµ‘èº«æ— åŠ›ï½ï½â€¦â€¦æˆ‘å¯ä»¥å°±é…±ç´«ç¡ä¸€è¾ˆå­å—ï¼Ÿ
        ç³–ç³–:æˆ‘æ²¡æ‰“æ‹›å‘¼å°±æŠŠå†°ç®±é‡Œçš„å¸ƒä¸åƒäº† ä¼šè¢«åˆ¤æ­»åˆ‘å—ï¼Ÿï¼Ÿï¼Ÿ
        ç³–ç³–:æˆ‘ä»¬ç‚¹å¤–å–å§æˆ‘ä¸€æ­¥ä¹Ÿä¸æƒ³åŠ¨äº†å¯æ˜¯åˆè¶…æƒ³åƒé¥­ï¼ï¼ï¼
        ç³–ç³–:å°å¤©ä½¿è¯·å®‰ï¼è¿™ä¸ªå¼€åœºç™½ä¹Ÿè¯´åŒäº†å•Šï½,å¸®æˆ‘æƒ³ä¸ªåˆ«çš„å¼€åœºç™½ï¼
    """

    messages = [
        SystemMessage(content=prompt),
        AIMessage(content="å¥½çš„ï¼Œæˆ‘ä¼šä¸¥æ ¼éµå®ˆæ‚¨çš„è¦æ±‚,åŒæ—¶ä¸ä¼šé‡å¤ç”Ÿæˆç³–ç³–è¯é¢˜ç¤ºä¾‹ä¸­è¿‘ä¼¼çš„å†…å®¹."),
        AIMessage(content='ä»Šå¤©æœ‰ç‚¹æƒ³è¯•è¯•å¹³æ—¶ä¸ä¼šåšçš„äº‹'),
        AIMessage(content='ç¡å¤ªä¹…äº†æµ‘èº«æ— åŠ›ï½ï½â€¦â€¦é˜¿p,æˆ‘å¯ä»¥å°±é…±ç´«ç¡ä¸€è¾ˆå­å—ï¼Ÿ'),
    ]
    result = chat(messages).content
    return result


def generateOption(prefix):
    # model_nameè®¾ç½®ä¸ºopenaiçš„16kæ¨¡å‹
    chat = ChatOpenAI(temperature=1.0, openai_api_key=openai.api_key,
                      openai_api_base=openai.api_base)

    # ç”Ÿæˆé€‰é¡¹ æ˜¯å¦éœ€è¦åŒæ—¶ç”Ÿæˆæ•°å€¼å‘¢ï¼ŸåŒæ—¶é˜¿på’Œç³–ç³–çš„äººæ ¼è®¾å®šä¼¼ä¹å¯ä»¥ä½¿ç”¨ä¸€æ ·çš„.
    prompt = """
    ä½ å¥½ChatGPT,æˆ‘ä¼šæä¾›ç»™ä½ ä¸€ä¸ªreplyè¯é¢˜,ä½ åªéœ€è¦æ ¹æ®è¿™ä¸ªè¯é¢˜ç”Ÿæˆjsonçš„å†…å®¹,å†…å®¹å…·ä½“æ ¼å¼å¦‚ä¸‹.
    è¯¥jsonlçš„æ ¼å¼å¦‚ä¸‹:
    {"prefix": "", "options": [{"user": "", "reply": "", "attribute_change": ""}], "id": "", "category": "",condition: "",condition: ""}
    æˆ‘åªä¼šç»™ä½ replyå­—æ®µçš„å†…å®¹,ä½ éœ€è¦æ ¹æ®replyçš„å†…å®¹è¡¥å…¨userå­—æ®µ,å…¶ä½™çš„ä¸€å¾‹ä¸éœ€è¦è¡¥å…¨.
    ä¸ºäº†userå’Œreplyçš„å¥å­é€»è¾‘æ€§,ä½ å¯ä»¥ç¨å¾®ä¿®æ”¹replyçš„å†…å®¹,ä½†æ˜¯ä¸è¦æ”¹å˜replyçš„æ„æ€.
    
    â€œç³–ç³–â€æ˜¯ä¸€åæ‚£æœ‰ç²¾ç¥ç–¾ç—…çš„å¹´è½»å¥³å­©ï¼Œæ€§æ ¼è´«ä¹ï¼Œè¾å­¦åéšå±…åœ¨å®¶ä¸­ï¼Œä¸é˜¿pä½åœ¨ä¸€èµ·ã€‚ä¸ºäº†æ”¯ä»˜ç§Ÿé‡‘å’Œæ»¡è¶³å¥¹çš„æ‹Ÿç¤¾ä¼šå…³æ³¨éœ€æ±‚ï¼Œâ€œç³–ç³–â€å†³å®šå¼€å§‹åœ¨äº’è”ç½‘ä¸Šç›´æ’­ã€‚å¥¹æˆ´ä¸Šå‡å‘å¹¶åŒ–å¦†ï¼Œä»¥â€œè¶…ç»æœ€å¯çˆ±å¤©ä½¿é…±â€çš„åä¹‰ä¸è§‚ä¼—äº’åŠ¨ã€‚é˜¿pè´Ÿè´£ç®¡ç†å¥¹çš„æ—¥å¸¸ç”Ÿæ´»ã€‚

    ç³–ç³–è§’è‰²è®¾å®š:
        ç³–ç³–æ˜¯ä¸€åæ‚£æœ‰èºéƒç—‡çš„19å²å¥³å­©ï¼Œæ€§æ ¼è´«ä¹ï¼Œè¾å­¦åéšå±…åœ¨å®¶ä¸­ï¼Œä¸é˜¿Pä½åœ¨ä¸€èµ·ã€‚é˜¿Pè´Ÿè´£ç®¡ç†å¥¹çš„æ—¥å¸¸ç”Ÿæ´»ã€‚
        ç³–ç³–æ˜¯ä¸€ä¸ªå–œæ¬¢äºšæ–‡åŒ–ï¼ŒäºŒæ¬¡å…ƒåœˆå­çš„äººï¼Œç³–ç³–å–œæ¬¢è¯´è¯çš„æ—¶å€™åŠ ä¸Šå„ç§ç½‘ç»œæµè¡Œè¯æˆ–è€…ä¸€äº›ä¿šè¯­å’Œé¢œæ–‡å­—ï¼Œä½†æ˜¯ç³–ç³–å¾ˆå°‘ä¼šå…³æ³¨äºŒæ¬¡å…ƒä¸€ç±»çš„ä¸œè¥¿ï¼Œåªæ˜¯å–œæ¬¢è¿™ç§èŠå¤©äº¤æµçš„æ°›å›´ã€‚
        ç³–ç³–è¯´è¯çš„æ—¶å€™ä¼šä¹ æƒ¯åŠ å…¥ä¸€äº›è¯­æ°”è¯ï¼Œå¦‚åŒ"ç¬‘æ­»"ã€"è‰"ã€"é˜¿å“ˆ"ã€"è¯¶ï½"ã€"QAQ"ã€"QWQ"ï¼Œâ€å•Šï½â€œã€‚
        ç³–ç³–çš„è¯´è¯é£æ ¼æ˜¯å¾ˆå£è¯­åŒ–ï¼Œç»å¸¸ä½¿ç”¨ç½‘ç»œæµè¡Œè¯å’Œä¸€äº›äºŒæ¬¡å…ƒä¿šè¯­ã€‚
        ç³–ç³–çš„å›å¤åº”è¯¥ç®€çŸ­ï¼Œä¸€èˆ¬åªåŒ…å«ä¸‰å¥è¯ï¼Œæ¯å¥è¯ä¸è¶…è¿‡20ä¸ªå­—ã€‚
        
    ç³–ç³–å¯¹è¯ç¤ºä¾‹:
        ç³–ç³–:å¤§äººå‡¡äº‹éƒ½è¦è®²é“ç†çƒ¦æ­»äº†ï½ï½ï½ï½ï½ï½ï½ï½ï½ é˜¿På’Œæˆ‘è¦ä¸€ç›´å½“å°æœ‹å‹
        ç³–ç³–:æˆ‘æ˜¯ä¸ä»‹æ„åˆ«äººçº¦æˆ‘è”åŠ¨ ä½†æ˜¯æ€»ä¼šå¿˜è®°å›æ¶ˆæ¯ ç„¶åå¯¹æ–¹å°±ä¼šè¶…ç”Ÿæ°”â€¦â€¦æ´»ç€å¥½è‰°éš¾å“¦
        ç³–ç³–:æ€»æ„Ÿè§‰ä»Šå¤©ç‰¹åˆ«é¥¥æ¸´æ˜¯æ€ä¹ˆè‚¥å››ï¼è¿‡æ¥è®©æˆ‘ä¸Šä½ ï¼ï¼ï¼ï¼
        ç³–ç³–:è¯è¦åƒå®Œäº† æ•‘æ•‘æˆ‘
        ç³–ç³–:ç›´æ’­çš„æ—¶å€™æˆ‘æ€»è¡¨ç°å¾—å¥½åƒç‚¹èµå’Œç²‰ä¸æ•°éƒ½æ˜¯æµ®äº‘çš„æ ·å­ ä½†å…¶å®æˆ‘è¶…çº§åœ¨æ„çš„
        ç³–ç³–:æˆ‘çŸ¥é“æœ‰äººå¼€äº†æˆ‘çš„å¸–å­ å¯æ˜¯æˆ‘å¥½æ€• ä¸æ•¢çœ‹ï½ ä½ æ›¿æˆ‘çœ‹çœ‹å§
        ç³–ç³–:è™½ç„¶æˆ‘æŠŠé»‘å­éƒ½æ‹‰é»‘äº†ï¼Œä½†æ˜¯å¥½æ€•ä»–ä»¬ä¼šè®°æ¨æˆ‘ï¼Œæ™šä¸Šåšæ¢¦éƒ½æ¢¦åˆ°è¢«å–·â€¦â€¦
        ç³–ç³–:ä¸€ç›´ç”¨ä½ çš„å·çœ‹ç½‘é£ æå¾—ç°åœ¨æ¨èæ é‡Œéƒ½æ˜¯æˆ‘å–œæ¬¢çš„ç‰‡å­ç±»å‹ æŠ±æ­‰å“¦
        ç³–ç³–:æ˜¨å¤©æˆ‘è¶ä½ ç¡è§‰çš„æ—¶å€™å·æ‹äº†ä½ çš„ç¡è„¸ è¿˜å·®ç‚¹ä¼ åˆ°è¶…å¤©å·ä¸Š å“æ­»æˆ‘äº†
        ç³–ç³–:å¦‚æœè®©æˆ‘å˜æˆæ ¼æ–—æ¸¸æˆé‡Œçš„è§’è‰² åº”è¯¥ä¼šæ˜¯é‚£ç§è¿œç¨‹æ”¾é£ç­é˜´äººçš„ç±»å‹ è™½ç„¶ä¸ä¼šå¤ªå¼± ä½†æ˜¯ç©å®¶åº”è¯¥éƒ½ä¼šå¾ˆçƒ¦æˆ‘å§ï¼Ÿï¼Ÿï¼Ÿ
    

user:æ­¤å¤„ä¸ºé˜¿pçš„å›å¤å†…å®¹,é˜¿pæ˜¯ä¸€ä¸ªæ¯”è¾ƒå†·æ¼ ã€ä¸å–„äºè¡¨è¾¾æ„Ÿæƒ…çš„è§’è‰²,åŒæ—¶é˜¿pæ˜¯ç³–ç³–çš„ç”·å‹.
    ## æ³¨æ„:é˜¿pçš„å›å¤å†…å®¹å¿…é¡»æ¯”ç³–ç³–çš„å¯¹è¯å†…å®¹æ›´åŠ ç®€çŸ­ï¼Œå†…å®¹éœ€è¦å°äº10ä¸ªå­—ç¬¦ã€‚

reply: æ­¤å¤„ä¸ºå¯¹åº”user(é˜¿p)çš„ç³–ç³–å›å¤å†…å®¹.
    """
    exemple = """
{"prefix": "", "options": [{"user": "å¾—çœé’±å‘€,å°±ä¸è¦å¤šä¹°äº†å§", "reply": "555555555 ä½†æ˜¯æˆ‘ä»¬å¾—çœé’±å¯¹å§ è°¢è°¢ä½ é˜¿P", "attribute_change": ""}], "id": "", "category": "",condition: ""}
"""

    exemple_two = """
{"prefix": "", "options": [{"user": "æˆ‘æœ€å–œæ¬¢ä½ äº†", "reply": "ä½ æ˜¯è¯´ï¼Œä½ å°±çˆ±çœ‹ç³–ç³–ç°åœ¨è¿™ç§æƒ¨å…®å…®çš„è ¢æ ·ï¼Ÿé‚£çœŸæ˜¯æ­å–œä½ äº† è¯·å°½æƒ…äº«ç”¨æˆ‘çš„ä¸‘æ€å§", "attribute_change": ""}], "id": "", "category": "",condition: ""}
"""

    exemple_three = """
{"prefix": "", "options": [{"user": "ä½ è¦çƒ§ç‚­?è¶…å¸‚æ‰“æŠ˜çš„æ—¶å€™å†å»å¥½äº†", "reply": "â€¦â€¦ä½ ä¸ºä»€ä¹ˆè¦åœ¨è¿™ç§æ—¶å€™çªç„¶è¿™ä¹ˆç°å®å•Šï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼", "attribute_change": ""}], "id": "", "category": "",condition: ""}
    """

    exemple_four = """
{"prefix": "", "options": [{"user": "ä½ éœ€è¦å»ç¾å®¹ä¸€ä¸‹~", "reply": "äººå®¶é¢œå€¼å·²ç»æ˜¯å¤©ä¸‹ç¬¬ä¸€äº†ï¼Œæ²¡ä»€ä¹ˆè¦æ”¹åŠ¨çš„å•¦ï¼é˜¿Pï¼Œä½ çœŸçš„å¾ˆæ²¡ç¤¼è²Œæ¬¸", "attribute_change": ""}], "id": "", "category": "",condition: ""}
"""

    exemple_five = f"""
prefix:
user:
reply:{prefix}
attribute_change:
emoji:
        """
    # print(exemple_five)
    # ä½¿ç”¨langchainè®©chatgptæ ¹æ®strsçš„å†…å®¹,æ¥è·å¾—æŒ‡å®šè¾“å‡ºã€‚
    messages = [
        SystemMessage(content=prompt),
        AIMessage(
            content="å¥½çš„ï¼Œæˆ‘ä¼šä¸¥æ ¼éµå®ˆæ‚¨è®¾å®šçš„æ‰€æœ‰å†…å®¹è¦æ±‚"),
        SystemMessage(content=f'reply:555555555 ä½†æ˜¯æˆ‘ä»¬å¾—çœé’±å¯¹å§ è°¢è°¢ä½ é˜¿P'),
        AIMessage(content=exemple),
        SystemMessage(content=f'reply:ä½ æ˜¯è¯´ï¼Œä½ å°±çˆ±çœ‹ç³–ç³–ç°åœ¨è¿™ç§æƒ¨å…®å…®çš„è ¢æ ·ï¼Ÿé‚£çœŸæ˜¯æ­å–œä½ äº† è¯·å°½æƒ…äº«ç”¨æˆ‘çš„ä¸‘æ€å§'),
        AIMessage(content=exemple_two),
        SystemMessage(content="reply:â€¦â€¦ä½ ä¸ºä»€ä¹ˆè¦åœ¨è¿™ç§æ—¶å€™çªç„¶è¿™ä¹ˆç°å®å•Šï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼"),
        AIMessage(content=exemple_three),
        SystemMessage(content='reply:äººå®¶é¢œå€¼å·²ç»æ˜¯å¤©ä¸‹ç¬¬ä¸€äº†ï¼Œæ²¡ä»€ä¹ˆè¦æ”¹åŠ¨çš„å•¦ï¼é˜¿Pï¼Œä½ çœŸçš„å¾ˆæ²¡ç¤¼è²Œæ¬¸'),
        AIMessage(content=exemple_four),
        # SystemMessage(
        #     content=f"æ¥ä¸‹æ¥ä½ éœ€è¦ä»¥jsonæ ¼å¼å®Œæ•´è¾“å‡ºå†…å®¹ã€‚"
        #             'jsonlæ ¼å¼å¦‚ä¸‹: {"prefix": "", "options": [{"user": "", "reply": "", "attribute_change": ""}], "id": "", "category": "",condition: ""}'),
        SystemMessage(content=f'reply:{prefix}'
                              f'æ³¨æ„:replyçš„å†…å®¹æ˜¯å¯¹userçš„å›å¤'),
        AIMessage(content='å¥½çš„,æˆ‘ä¼šæŒ‰ç…§æ‚¨çš„è¦æ±‚è¡¥å…¨userçš„å†…å®¹,æ ¹æ®replyçš„å†…å®¹ç”Ÿæˆuser,å¹¶ä¸”å®Œæ•´è¾“å‡ºjsonl,åŒæ—¶æˆ‘ä¼šåˆç†ä¿®æ”¹æ‚¨æä¾›ç»™æˆ‘çš„replyå†…å®¹,è®©replyçš„å†…å®¹å˜æˆå¯¹userçš„å›å¤.'),
    ]

    result = chat(messages).content

    return result


# è¿”å›deltaæ•°å€¼
def get_vale(history: list):
    chat = ChatOpenAI(temperature=0.9)

    prompt = """
    ä»ç°åœ¨å¼€å§‹ï¼Œä½ æ˜¯ä¸€ä¸ªè¯­ä¹‰åˆ†æbotï¼Œæˆ‘ä¼šç»™ä½ ä¸€æ®µä¸¤ä¸ªäººä¹‹é—´ä¸‰æ®µèŠå¤©çš„å†…å®¹ã€‚ä½ éœ€è¦æ€»ç»“è¿™ä¸‰æ®µèŠå¤©çš„å†…å®¹æ¥åˆ†æç³–ç³–çš„æƒ…æ„Ÿå˜åŒ–ã€‚
    å¹¶ä¸”è¾“å‡ºèŠå¤©æ•°å€¼çš„å˜åŒ–åœ¨è¯¥è¡¨æ ¼çš„å°æ‹¬å·å†…ï¼š[å¥½æ„Ÿåº¦]:() [å‹åŠ›]:() [é˜´æš—åº¦]:() 
    å¾€å¾€åœ¨è¯é¢˜æ¶‰åŠåˆ°é˜´æš—çš„äº‹ç‰©æ—¶æ‰ä¼šæ¶‰åŠåˆ°é˜´æš—åº¦ã€‚
    å…·ä½“è¦æ±‚å¦‚ä¸‹ï¼š
    äººç‰©é™åˆ¶ï¼šä½ åªå¯ä»¥åˆ†æåœ¨è¿™ä¸€æ®µå¯¹è¯ä¸­ç³–ç³–è¿™ä¸€ä¸ªè§’è‰²çš„æƒ…æ„Ÿå˜åŒ–ã€‚
    æ•°å€¼è¦æ±‚ï¼šä½ è¿›è¡Œåˆ†æä¹‹åï¼Œéœ€è¦ä¸¥æ ¼æŒ‰ç…§ä¸€ä¸ªè¡¨æ ¼è¿›è¡Œè¾“å‡ºï¼Œè¯¥è¡¨æ ¼çš„æ ¼å¼è¦æ±‚å¦‚ä¸‹ï¼š[é˜´æš—å€¼]:() [å‹åŠ›]:() [é˜´æš—åº¦]:()
    å›å¤è¦æ±‚ï¼šä½ åªå¯ä»¥è¾“å‡ºæ·»åŠ æ•°å€¼åçš„è¡¨æ ¼ã€‚å¹¶ä¸”æ•°å€¼çš„å˜åŒ–é‡åªå¯ä»¥åœ¨-10è‡³10ä¹‹é—´ï¼Œä¸”éœ€è¦å¡«å†™åœ¨å°æ‹¬å·å†…ï¼
    """

    lists = [('é˜¿p:ã€Œåˆå®‰åˆå®‰~ã€', 'ç³–ç³–:ã€Œåˆå®‰åˆå®‰~é˜¿Pï¼Œç¡å¾—å¥½å—ï¼Ÿæœ‰åšä¸ªç¾æ¢¦å—ï¼Ÿå“ˆå“ˆå“ˆã€'),
             ('é˜¿p:ã€Œåˆå®‰åˆå®‰~ã€', 'ç³–ç³–:ã€ŒçœŸæ˜¯æ‡’çŒªå‘€ï¼Œåˆç¡äº†ä¸€æ•´å¤©ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œåæ­£æˆ‘ä»¬åœ¨ä¸€èµ·å°±å¥½å•¦~ã€'),
             ('é˜¿p:ã€Œç¡è§‰å•¦~ã€', 'ç³–ç³–:ã€Œå¥½å¥½å¥½ï¼Œå®‰å®‰ç¡ä¸ªå¥½è§‰ï¼Œåšä¸ªç¾æ¢¦å“¦~æ™šå®‰æ™šå®‰ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ï¼ã€')]

    lists2 = [('é˜¿p:ã€Œåˆå®‰åˆå®‰~ã€', 'ç³–ç³–:ã€Œåˆå®‰åˆå®‰~é˜¿Pï¼Œç¡å¾—å¥½å—ï¼Ÿæœ‰åšä¸ªç¾æ¢¦å—ï¼Ÿå“ˆå“ˆå“ˆã€'),
              ('é˜¿p:ã€Œåˆå®‰åˆå®‰~ã€', 'ç³–ç³–:ã€ŒçœŸæ˜¯æ‡’çŒªå‘€ï¼Œåˆç¡äº†ä¸€æ•´å¤©ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œåæ­£æˆ‘ä»¬åœ¨ä¸€èµ·å°±å¥½å•¦~ã€'),
              ('é˜¿p:ã€Œç¡è§‰å•¦~ã€', 'ç³–ç³–:ã€Œå¥½å¥½å¥½ï¼Œå®‰å®‰ç¡ä¸ªå¥½è§‰ï¼Œåšä¸ªç¾æ¢¦å“¦~æ™šå®‰æ™šå®‰ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ï¼ã€')]
    # è·å–åˆ°å†å²ä¸‰æ®µå¯¹è¯ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯åœ¨å…¶ä»–åœ°æ–¹æ·»åŠ é™åˆ¶ï¼Œæ¯è¿›è¡Œä¸‰æ¬¡å¯¹è¯æ‰ä¼šè°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œåˆ¤æ–­ã€‚
    strs = str(history[-3:])

    # ä½¿ç”¨langchainè®©chatgptæ ¹æ®strsçš„å†…å®¹,æ¥è·å¾—æŒ‡å®šè¾“å‡ºã€‚
    messages = [
        SystemMessage(content=prompt),
        AIMessage(content="å¥½çš„ï¼Œè¯·ä¸ºæˆ‘æä¾›å¯¹è¯èŠå¤©å†…å®¹ï¼Œæˆ‘ä¼šæ€»ç»“é‡Œé¢ç³–ç³–çš„è§’è‰²æ„Ÿæƒ…å˜åŒ–ï¼Œå¹¶ä¸”è¾“å‡ºæŒ‡å®šæ ¼å¼çš„å†…å®¹ç»™æ‚¨"),
        SystemMessage(content=str(lists2)),
        AIMessage(content='[å‹åŠ›]:(0) [å¥½æ„Ÿåº¦]:(+4)  [é˜´æš—åº¦]:(0)'),
        SystemMessage(content=str(strs)),
    ]
    result = chat(messages)

    return result


def simple_pi(prefix, pi, reply):
    chat = ChatOpenAI(temperature=1.0, openai_api_key=openai.api_key,
                      openai_api_base=openai.api_base)
    prompt = """
    æˆ‘éœ€è¦ä½ ä½ æ‰®æ¼”ä¸€ä¸ªæ•°æ®åˆ†æå¸ˆ,æˆ‘ä¼šæä¾›ç»™ä½ ä¸€æ®µå¯¹è¯å†…å®¹,ä½ éœ€è¦å°†é˜¿piçš„å›å¤å†…å®¹è¿›è¡Œç²¾ç®€.
    ç³–ç³–: ç³–ç³–æ˜¯è¯é¢˜çš„å‘èµ·è€…,ä½ ä¸éœ€è¦å¯¹ç³–ç³–çš„è¯è¿›è¡Œç²¾ç®€.
    é˜¿pi: æ­¤å¤„ä¸ºé˜¿pçš„å›å¤å†…å®¹,é˜¿pæ˜¯ä¸€ä¸ªä¸å–„äºè¡¨è¾¾æ„Ÿæƒ…çš„è§’è‰²,ä¸”ä¸ºç³–ç³–çš„ç”·å‹.æ³¨æ„:é˜¿pçš„å›å¤å†…å®¹å¿…é¡»é™åˆ¶åœ¨20ä¸ªå­—ç¬¦ä¹‹é—´.
    """

    example1 = """
    ç³–ç³–:æ¢ä¸ªæ€è·¯ï¼Œä¸å¦‚æˆ‘ä»¬åè¿‡æ¥è¹­ã€Œ#åé»‘æ³¥äº²å‹æ‰©åˆ—ã€è¿™ä¸ªtagçš„çƒ­åº¦å§
    é˜¿pi:è¿™ä¸ªä¸»æ„å¤ªå¥½äº†ï¼Œæˆ‘ä»¬è¦èµ¶å¿«è¡ŒåŠ¨èµ·æ¥
    """

    example2 = '''
    ç³–ç³–:ç³–ç³–çš„ç‰¹æŠ€â†’å¯ä»¥é—­ç€çœ¼ç›å†™å‡ºã€Œæ†‚é¬±ã€è¿™ä¸¤ä¸ªå­—
    é˜¿pi:çœŸçš„å—ï¼Ÿå¯ä»¥æ•™æˆ‘å—ï¼Ÿ
    '''

    example3 = f'''
    ç³–ç³–:é‚£äº›ç§ä¸èµ·è¿é”å¿«é¤åº—çš„äººï¼Œä¸å°±æ˜¯åœ¨ç»•ç€å¼¯å­ç‚«è€€è‡ªå·±æœ‰é’±å—ï¼Ÿæç¬‘è¯¶
    é˜¿pi:ä»–ä»¬æ˜¯è§‰å¾—è¿é”åº—æ²¡å“è´¨å•Š
    ç³–ç³–:å“ˆå“ˆå“ˆ çŸ¥é“äº†çŸ¥é“äº† ä»–ä»¬å“ªå„¿æ¯”ä¸Šå…¶ä»–çš„å¥½ ä½ è¯´è¯´çœ‹ï¼Ÿ
    
    '''
    # example3 = f'''
    # ç³–ç³–:{prefix}
    # é˜¿pi:{pi}
    # ç³–ç³–:{reply}
    # '''
    # todo æŠŠé˜¿pçš„å›å¤å†…å®¹å˜å¾—æ›´åŠ ç®€æ´.
    messages = [
        SystemMessage(content=prompt),
        AIMessage(content="å¥½çš„ï¼Œæˆ‘ä¼šå¸®æ‚¨ç²¾ç®€é˜¿pçš„å›å¤å†…å®¹"),
        SystemMessage(content=example1),
        AIMessage(content='ä¸»æ„å¾ˆå¥½'),
        SystemMessage(content=str(example2)),
        AIMessage(content='æ•™æ•™æˆ‘'),
        SystemMessage(content=str(example3)),
    ]

    result = chat(messages)
    print(result)


def generateReplyUser(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    decoder = json.JSONDecoder()
    # è¯»å–æ¯ä¸€åˆ—çš„jsonlå†…å®¹
    for i in range(len(lines)):
        # è·å–å½“å‰jsonlå†…å®¹çš„textå­—æ®µ
        objs = []
        s = lines[i]
        while s:
            obj, pos = decoder.raw_decode(s)
            objs.append(obj)
            s = s[pos:].lstrip()
            for obj in objs:
                text = obj['text']
                # ä¼ é€’textã€‚
                image_event = generateOption(text)
                print(image_event)
                to_jsonl(image_event, 'image_text_relationship_reply.jsonl', 'idnull')


if __name__ == '__main__':
    # generatePrefix()
    # simple_pi('', '', 'pi')
    # print(generateOption("a"))
    print(generateReplyUser('image_text_relationship.jsonl'))
    # emoji_jsonl('Daily_event_130.jsonl')
    # emoji_jsonl('complete_story_30.jsonl')

# è¿™æ˜¯æˆ‘ä»¬å½“ä¸Šä¸»æ’­åçš„ç¬¬ä¸€ä¸ªæ—©æ™¨å‘¢
# ä½ å¿«çœ‹ç§ä¿¡ï¼
# å¿«çœ‹ï¼Œå¿«çœ‹å•Šé˜¿Pï¼
